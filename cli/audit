#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd -P)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd -P)"

usage() {
    cat <<'EOF'
Usage: ./cli/audit <command> [args...]

Commands:
  mac                  Run mac audit surface (defaults to cleanup)
  mac cleanup [args]   Run home cleanup audit with pass-through args
  linux                Placeholder (not yet implemented)
  windows              Placeholder (not yet implemented)
  -h, --help           Show this help
EOF
}

run_mac_cleanup() {
    local cleanup_script="$REPO_ROOT/audit/mac/home-cleanup-audit.sh"
    if [ ! -f "$cleanup_script" ]; then
        echo "Error: cleanup script not found: $cleanup_script" >&2
        exit 1
    fi
    exec bash "$cleanup_script" "$@"
}

if [ "${1:-}" = "-h" ] || [ "${1:-}" = "--help" ]; then
    usage
    exit 0
fi

if [ "$#" -eq 0 ]; then
    # Preserve top-level behavior by mapping default invocation to mac.
    run_mac_cleanup
fi

case "$1" in
    mac)
        shift
        if [ "$#" -eq 0 ]; then
            run_mac_cleanup
        fi
        case "$1" in
            cleanup)
                shift
                run_mac_cleanup "$@"
                ;;
            *)
                echo "Error: unknown mac subcommand: $1" >&2
                usage >&2
                exit 1
                ;;
        esac
        ;;
    linux)
        echo "linux command is not yet implemented." >&2
        exit 1
        ;;
    windows)
        echo "windows command is not yet implemented." >&2
        exit 1
        ;;
    *)
        echo "Error: unknown command: $1" >&2
        usage >&2
        exit 1
        ;;
esac
